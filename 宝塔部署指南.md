# Coser社群机器人 - 宝塔部署指南

本文档提供在宝塔面板上部署Coser社群机器人的详细步骤。

## 前置要求

1. 已安装宝塔面板的Linux服务器（CentOS/Ubuntu）
2. 已开通Telegram Bot API访问权限（若服务器在中国大陆，需要确保可以连接Telegram API）
3. 已获取Telegram Bot Token

## 一、环境准备

### 1. 安装Python环境

1. 在宝塔面板中，转到【软件商店】
2. 安装【Python项目管理器】插件
3. 创建新的Python项目环境（Python 3.8+）

### 2. 安装Supervisor管理器

1. 在宝塔面板中，转到【软件商店】
2. 安装【Supervisor管理器】插件

## 二、项目部署

### 1. 上传项目文件

**方法一：通过宝塔文件管理器上传**

1. 在宝塔面板中，转到【文件】
2. 在服务器上创建一个目录，例如：`/www/wwwroot/coser-bot`
3. 将项目文件压缩后上传到该目录
4. 解压文件：
   ```bash
   cd /www/wwwroot/coser-bot
   unzip coser-bot.zip
   ```

**方法二：通过Git克隆**

1. 在服务器上安装Git（如果尚未安装）：
   ```bash
   yum install git -y  # CentOS
   apt install git -y  # Ubuntu
   ```
2. 克隆仓库：
   ```bash
   cd /www/wwwroot
   git clone https://github.com/didumi/coserbot.git
   ```

### 2. 配置项目

1. 进入项目目录：
   ```bash
   cd /www/wwwroot/coser-bot
   ```

2. 创建环境变量配置文件：
   ```bash
   cp .env.example .env
   ```

3. 编辑.env文件（可通过宝塔文件管理器编辑），填写以下必要信息：
   - `BOT_TOKEN`：您的Telegram Bot Token
   - `ADMIN_IDS`：管理员Telegram用户ID
   - `SMTP_*`：如需启用邮件功能，填写SMTP服务器配置

4. 安装依赖：
   ```bash
   python3 -m pip install -r requirements.txt
   ```

5. 创建必要目录并设置权限：
   ```bash
   mkdir -p data logs backups
   chmod -R 755 .
   chmod -R 777 logs data backups
   ```

### 3. 配置Supervisor

1. 在宝塔面板中，转到【Supervisor管理器】
2. 点击【添加守护进程】，填写以下信息：
   - 名称：coser-bot
   - 启动用户：www
   - 运行目录：/www/wwwroot/coser-bot
   - 启动命令：python3 /www/wwwroot/coser-bot/simple_bot.py
   - 进程数量：1
   - 勾选【是否启用】和【是否自启】
3. 点击【确定】保存配置

### 4. 使用部署脚本（可选）

如果您希望使用提供的部署脚本自动完成配置，可以执行以下操作：

1. 给脚本添加执行权限：
   ```bash
   chmod +x deploy.sh
   ```

2. 执行部署脚本：
   ```bash
   ./deploy.sh
   ```

## 三、验证部署

1. 在Supervisor管理器中检查进程状态，确认coser-bot进程处于运行状态。

2. 查看日志检查启动情况：
   ```bash
   tail -f logs/supervisor_stdout.log
   ```

3. 打开Telegram，向您的机器人发送 `/start` 命令测试是否响应。

## 四、常见问题排查

### 1. 机器人无法启动

- 检查日志文件获取详细错误信息
- 确认.env配置是否正确
- 确认Python版本是否满足要求（3.8+）
- 确认依赖安装是否完整

### 2. 无法连接Telegram API

- 检查服务器网络连接
- 如果服务器在中国大陆，需要配置代理以访问Telegram API
- 确认BOT_TOKEN是否正确

### 3. 进程频繁重启

- 检查日志了解具体错误原因
- 可能是配置文件错误或环境问题
- 确认服务器资源是否充足

## 五、维护与更新

### 1. 日志管理

日志文件位于`logs/`目录下，建议定期检查日志，或者通过日志管理系统集中管理。

### 2. 数据备份

系统会自动定期备份数据库到`backups/`目录。也可以手动备份：
```bash
cp coser_bot.db backups/coser_bot_$(date +%Y%m%d_%H%M%S).db
```

### 3. 更新代码

如果需要更新机器人代码，建议先备份数据，然后拉取最新代码并重启服务：
```bash
# 备份数据
cp coser_bot.db backups/coser_bot_$(date +%Y%m%d_%H%M%S).db

# 如果是通过Git部署的，可以拉取最新代码
git pull

# 重启服务
supervisorctl restart coser-bot
```

## 六、联系与支持

如果您在部署过程中遇到任何问题，请联系项目维护人员或提交issue获取支持。 

## 宝塔面板账号密码错误解决方法

看到您遇到了宝塔面板登录凭据错误的问题。以下是几种解决方案：

## 方法一：检查输入

1. 确认您输入的用户名和密码与安装完成时显示的完全一致
   - 用户名：tdpfjcgb
   - 密码：829dbd6a
2. 注意大小写、空格和特殊字符
3. 尝试复制粘贴密码而非手动输入

## 方法二：通过SSH重置密码

连接到您的服务器SSH，执行以下命令重置宝塔账号密码：

```bash
cd /www/server/panel && python3 tools.py panel 123456
```

这会将密码重置为"123456"，用户名保持不变。

## 方法三：查看正确的账号信息

执行以下命令查看当前宝塔面板的正确用户名和密码：

```bash
/etc/init.d/bt default
```

## 方法四：解除登录限制

如果您尝试次数已用完被锁定，执行：

```bash
rm -f /www/server/panel/data/*.login
```

然后重新尝试登录。

## 方法五：重装面板

如果上述方法都不起作用，可以考虑重新安装面板：

```bash
wget -O install.sh http://download.bt.cn/install/install-ubuntu.sh && bash install.sh
```

重装会生成新的用户名和密码。

---

建议先尝试方法一和方法二，这通常能解决大多数登录问题。您需要通过SSH连接到服务器来执行这些命令。需要我详细说明如何连接SSH吗？ 